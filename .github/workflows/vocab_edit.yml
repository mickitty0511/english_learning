name: Vocabulary Card - Edit

on:
  issues:
    types: [edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

jobs:
  edit:
    if: contains(github.event.issue.labels.*.name, 'generate')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core jq
          python3 -m pip install --upgrade pip
          python3 -m pip install pillow requests

      - name: Parse
        id: parse
        env:
          ISSUE_EVENT_JSON: ${{ toJson(github.event) }}
        run: python3 .github/scripts/diff_lines.py "$ISSUE_EVENT_JSON"

      - name: Probe DashScope (HTTP code only)
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        run: |
          set -euo pipefail
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${DASHSCOPE_API_KEY}" \
            -H "X-DashScope-Async: enable" \
            -H "Content-Type: application/json" \
            -d '{"model":"qwen-image-plus","input":{"prompt":"probe"},"parameters":{"size":"512*512","n":1}}' \
            https://dashscope-intl.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis)
          echo "DashScope probe: $code"
          [ "$code" = "200" ]

      - name: Re-generate changed cards
        if: steps.parse.outputs.changed_indices != ''
        env:
          WORD_DISPLAY: ${{ steps.parse.outputs.word_display }}
          WORD_SLUG: ${{ steps.parse.outputs.word_slug }}
          CHANGED: ${{ steps.parse.outputs.changed_indices }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "src/${WORD_SLUG}"
          IFS=',' read -ra IDX <<< "$CHANGED"
          for i in "${IDX[@]}"; do
            concept_var="CONCEPT_${i}"
            meaning_var="MEANING_${i}"
            example_var="EXAMPLE_${i}"
            concept="${!concept_var:-}"
            meaning="${!meaning_var:-}"
            example="${!example_var:-}"

            if [[ -z "$concept" || -z "$meaning" || -z "$example" ]]; then
              echo "Skipping index $i due to missing data."
              continue
            fi

            echo "Re-generating $i. $concept"
            python3 .github/scripts/generate_card.py \
              --api-key "$DASHSCOPE_API_KEY" \
              --word "$WORD_DISPLAY" \
              --index "$i" \
              --concept "$concept" \
              --meaning "$meaning" \
              --example "$example" \
              --outdir "src/$WORD_SLUG"
          done

      - name: Collect legibility data
        id: legibility
        run: |
          set -euo pipefail
          json=$(python3 .github/scripts/collect_legibility.py \
            --word "${{ steps.parse.outputs.word_display }}" \
            --slug "${{ steps.parse.outputs.word_slug }}")
          json=${json//$'\r'/}
          {
            echo 'report_json<<EOF'
            echo "$json"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Import GPG key for signing
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Commit and push
        run: |
          set -euo pipefail
          git config user.name  "${{ secrets.SIGNING_NAME }}"
          git config user.email "${{ secrets.SIGNING_EMAIL }}"
          git add "src/${{ steps.parse.outputs.word_slug }}/" "reports/" || true
          git commit -m "fix(cards): update ${{ steps.parse.outputs.word_display }}" || echo "no changes"

      - name: Clean up temp file
        run: rm -f cme.txt || true

      - name: Create PR (always)
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ github.token }}
          commit-message: "fix(cards): update ${{ steps.parse.outputs.word_display }}"
          branch: bot/vocab-${{ steps.parse.outputs.word_slug }}-${{ github.run_id }}
          title: "Vocab: ${{ steps.parse.outputs.word_display }}"
          body: |
            Auto-updated vocabulary card.
            - Word: ${{ steps.parse.outputs.word_display }}
            - Folder: src/${{ steps.parse.outputs.word_slug }}
          labels: bot,generate
          delete-branch: true

      - name: Approve PR automatically via GH CLI
        if: steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.APPROVER_TOKEN }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          gh pr review "$PR_NUMBER" --repo "$REPO" --approve --body "Auto-approved by machine user"

      - name: Enable auto-merge via GH CLI (squash)
        if: steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          gh pr merge "$PR_NUMBER" --repo "$REPO" --squash --auto

      - name: Log PR URL
        if: steps.cpr.outputs.pull-request-url != ''
        run: echo "PR = ${{ steps.cpr.outputs.pull-request-url }}"

      - name: Comment with structured sections
        uses: actions/github-script@v7
        with:
          script: |
            const github = require('@actions/github');
            const context = github.context;

            const word = '${{ steps.parse.outputs.word_display }}';
            const slug = '${{ steps.parse.outputs.word_slug }}';
            const headSha = '${{ steps.cpr.outputs.pull-request-head-sha }}' || '${{ github.sha }}';
            const repoBase = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${headSha}/src/${slug}`;

            const LINE_RE = /^\s*(\d+)\.\s*([^,|]+)[,|]\s*([^,|]+)[,|]\s*(.+)$/;
            const sanitize = value => (value || '').toString().trim();
            const slugify = (value = '') =>
              value
                .toLowerCase()
                .trim()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9\-_]/g, '') || 'concept';

            const cards = [];
            for (const raw of (context.payload.issue?.body || '').split(/\r?\n/)) {
              const line = raw.trim();
              if (!line) continue;
              const match = line.match(LINE_RE);
              if (!match) continue;
              const [, idx, concept, meaning, example] = match;
              cards.push({
                idx: Number(idx),
                concept: sanitize(concept),
                meaning: sanitize(meaning),
                example: sanitize(example)
              });
            }

            cards.sort((a, b) => a.idx - b.idx);
            console.log(`[comment-build] parsed-cards: ${JSON.stringify(cards)}`);

            if (!cards.length) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’Issueæœ¬æ–‡ã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
              });
              return;
            }

            const lines = [`## ${word}`, ''];
            for (const card of cards) {
              const idx = card.idx;
              const concept = card.concept || `Concept ${idx}`;
              const meaning = card.meaning || 'N/A';
              const example = card.example || 'N/A';
              const filename = `${idx}_${slugify(concept)}.jpg`;

              console.log(`[comment-build] composed-card: ${JSON.stringify({ idx, concept, filename })}`);

              lines.push(
                `### ${idx}. ${concept}`,
                `- Meaning: ${meaning}`,
                `- Example: ${example}`,
                '',
                `![${concept}](${repoBase}/${encodeURIComponent(filename)}?raw=true)`,
                ''
              );
            }

            const body = lines.join('\n').replace(/\n{3,}/g, '\n\n').trimEnd();
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Comment Legibility Report
        uses: actions/github-script@v7
        env:
          REPORT_JSON: ${{ steps.legibility.outputs.report_json }}
        with:
          script: |
            const github = require('@actions/github');
            const context = github.context;

            const word = '${{ steps.parse.outputs.word_display }}';
            const slug = '${{ steps.parse.outputs.word_slug }}';
            const headSha = '${{ steps.cpr.outputs.pull-request-head-sha }}' || '${{ github.sha }}';
            const repoBase = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${headSha}/src/${slug}`;

            let rows = [];
            try {
              const raw = process.env.REPORT_JSON || '[]';
              rows = JSON.parse(raw);
            } catch (error) {
              console.log(`[legibility] failed to parse report JSON: ${error.message}`);
            }

            if (!Array.isArray(rows) || rows.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ Legibility data was not available for ${word}.`
              });
              return;
            }

            const header = [
              `ðŸ”Ž **Legibility Report for ${word}**`,
              '',
              '| index | concept | score | status | preview |',
              '|-------|---------|-------|--------|---------|'
            ];

            const bodyLines = rows.map(row => {
              const idx = row.index ?? '';
              const concept = row.concept ?? '';
              const score = row.score ?? '';
              const status = row.status ?? '';
              const image = row.image ?? '';
              const preview = image
                ? `![img](${repoBase}/${encodeURIComponent(image)}?raw=true)`
                : '';
              return `| ${idx} | ${concept} | ${score} | ${status} | ${preview} |`;
            });

            const md = [...header, ...bodyLines].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: md
            });
