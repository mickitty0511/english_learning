name: Vocabulary Card - Create
on:
  issues:
    types: [opened]
permissions:
  contents: write
  issues: write

jobs:
  create:
    if: contains(github.event.issue.labels.*.name, 'generate')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core
          python3 -m pip install pillow requests jq

      - name: Parse
        id: parse
        env:
          ISSUE_EVENT_JSON: ${{ toJson(github.event) }}
        run: python3 .github/scripts/diff_lines.py "$ISSUE_EVENT_JSON"

      - name: Generate cards
        env:
          WORD_DISPLAY: ${{ steps.parse.outputs.word_display }}
          WORD_SLUG: ${{ steps.parse.outputs.word_slug }}
          DEEPAI_API_KEY: ${{ secrets.DEEPAI_API_KEY }}
        run: |
          mkdir -p "src/${WORD_SLUG}"
          body=$(jq -r '.issue.body' <<< '${{ toJson(github.event) }}')
          awk '/^1\./,/^$/' <<< "$body" > cme.txt
          while read -r line; do
            [[ "$line" =~ ^[0-9]+\.\ ([^,|]+)[,|]\ ([^,|]+)[,|]\ (.+)$ ]] || continue
            idx="${BASH_REMATCH[0]%%.*}"
            concept="${BASH_REMATCH[1]}"
            meaning="${BASH_REMATCH[2]}"
            example="${BASH_REMATCH[3]}"
            python3 .github/scripts/generate_card.py \
              --api-key "$DEEPAI_API_KEY" \
              --word "$WORD_DISPLAY" \
              --index "$idx" \
              --concept "$concept" \
              --meaning "$meaning" \
              --example "$example" \
              --outdir "src/$WORD_SLUG"
          done < cme.txt

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "src/${{ steps.parse.outputs.word_slug }}/"
          git commit -m "feat(cards): create ${{ steps.parse.outputs.word_display }}" || echo "no changes"
          git push

      # â‘  ç”»åƒä»˜ãæ§‹é€ ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment with structured sections
        uses: actions/github-script@v7
        with:
          script: |
            const { context } = github;
            const word = '${{ steps.parse.outputs.word_display }}';
            const slug = '${{ steps.parse.outputs.word_slug }}';
            const defaultBranch = context.payload.repository.default_branch || 'main';
            const repoBase = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${defaultBranch}/src/${slug}`;
            const fs = require('fs');
            const dir = `src/${slug}`;
            const metaDir = `${dir}/.meta`;
            let lines = [];
            lines.push(`## ${word}`, '');
            const files = fs.existsSync(dir)
              ? fs.readdirSync(dir).filter(f => f.endsWith('.jpg')).sort()
              : [];
            for (const f of files) {
              const idx = f.split('_')[0];
              const concept = f.split('_').slice(1).join('_').replace('.jpg','');
              let meaning=''; let example='';
              const metaPath = `${metaDir}/${idx}_${concept}.json`;
              if (fs.existsSync(metaPath)) {
                const meta = JSON.parse(fs.readFileSync(metaPath,'utf8'));
                meaning = meta.meaning || '';
                example = meta.example || '';
              }
              lines.push(
                `### ${idx}. ${concept}`,
                `- Meaning: ${meaning}`,
                `- Example: ${example}`,
                '',
                `![${f}](${repoBase}/${encodeURIComponent(f)}?raw=true)`,
                ''
              );
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join('\n')
            });

      # â‘¡ ã‚¹ã‚³ã‚¢ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼‹ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Generate Legibility Report
        run: python3 .github/scripts/collect_legibility.py \
          --word "${{ steps.parse.outputs.word_display }}" \
          --slug "${{ steps.parse.outputs.word_slug }}"

      - name: Comment Legibility Report
        uses: actions/github-script@v7
        with:
          script: |
            const word = '${{ steps.parse.outputs.word_display }}';
            const slug = '${{ steps.parse.outputs.word_slug }}';
            const fs = require('fs');
            const path = require('path');
            const reportPath = path.join('reports/layout_scores', `${slug}.csv`);
            const repoBase = `https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/src/${slug}`;
            if (!fs.existsSync(reportPath)) return;
            const lines = fs.readFileSync(reportPath, 'utf8').trim().split('\n').slice(1);
            const md = [
              `ðŸ”Ž **Legibility Report for ${word}**`,
              '',
              '| index | concept | score | status | preview |',
              '|-------|----------|--------|---------|----------|',
              ...lines.map(l=>{
                const [i,c,s,st,img]=l.split(',');
                return `| ${i} | ${c} | ${s} | ${st} | ![img](${repoBase}/${encodeURIComponent(img)}?raw=true) |`;
              })
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: md
            });
